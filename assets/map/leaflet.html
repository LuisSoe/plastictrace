<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlastiTrace Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            width: 100%;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <script>
        // Initialize map centered on Jakarta
        var map = L.map('map').setView([-6.2297, 106.7997], 12);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Marker cluster group
        var markers = L.markerClusterGroup({
            chunkedLoading: true,
            maxClusterRadius: 50
        });
        map.addLayer(markers);
        
        // User location marker
        var userMarker = null;
        
        // Selected marker
        var selectedMarker = null;
        
        // Bridge object for QWebChannel communication
        var bridge = {
            // Set user location
            setUserLocation: function(lat, lon) {
                if (userMarker) {
                    map.removeLayer(userMarker);
                }
                userMarker = L.marker([lat, lon], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34]
                    })
                }).addTo(map);
                userMarker.bindPopup("Lokasi Anda").openPopup();
            },
            
            // Clear all markers
            clearMarkers: function() {
                markers.clearLayers();
            },
            
            // Add location marker
            addLocation: function(id, name, lat, lon, address, distance, types) {
                var marker = L.marker([lat, lon], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34]
                    })
                });
                
                var popupContent = '<div style="min-width: 200px;">' +
                    '<h3 style="margin: 0 0 8px 0; font-size: 14px;">' + name + '</h3>' +
                    '<p style="margin: 4px 0; font-size: 12px; color: #666;">' + address + '</p>' +
                    '<p style="margin: 4px 0; font-size: 12px;"><strong>Jarak:</strong> ' + distance.toFixed(2) + ' km</p>' +
                    '<p style="margin: 4px 0; font-size: 12px;"><strong>Jenis:</strong> ' + types.join(', ') + '</p>' +
                    '<button onclick="bridge.navigate(' + lat + ', ' + lon + ')" style="margin-top: 8px; padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;">Navigasi</button>' +
                    '</div>';
                
                marker.bindPopup(popupContent);
                marker.on('click', function() {
                    if (selectedMarker) {
                        selectedMarker.setIcon(L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41]
                        }));
                    }
                    selectedMarker = marker;
                    marker.setIcon(L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                        iconSize: [30, 48],
                        iconAnchor: [15, 48]
                    }));
                    bridge.onMarkerClicked(id);
                });
                
                markers.addLayer(marker);
            },
            
            // Fit bounds to show all markers
            fitBounds: function() {
                if (markers.getLayers().length > 0) {
                    map.fitBounds(markers.getBounds().extend(userMarker ? userMarker.getLatLng() : []), {
                        padding: [50, 50]
                    });
                }
            },
            
            // Pan to location
            panTo: function(lat, lon) {
                map.panTo([lat, lon], {animate: true});
            },
            
            // Navigate callback (opens Google Maps)
            navigate: function(lat, lon) {
                var url = 'https://www.google.com/maps/dir/?api=1&destination=' + lat + ',' + lon;
                bridge.openUrl(url);
            },
            
            // Callbacks (will be set by QWebChannel)
            onMarkerClicked: function(id) {},
            openUrl: function(url) {}
        };
        
        // Expose bridge to window
        window.bridge = bridge;
    </script>
</body>
</html>

